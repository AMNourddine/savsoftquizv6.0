Project Operations Manual

Overview

- Containers: `quiz_gam_quiz` (app) and `mariadb_gam_quiz` (database)
- Images (Docker Hub):
  - App: `nourddinelearning/savsoftquiz-gam_quiz:latest` (recommended: pin to a version tag)
  - DB: `nourddinelearning/mariadb-gam_quiz:10.6`
- Compose file: `docker-compose.yml`
- Default admin (seed data): username `admin`, password `admin`

Start / Stop

- Start: `docker compose up -d`
- Stop: `docker compose down`
- Pull latest images then restart: `docker compose pull && docker compose up -d`

Health Checks

- UI: `http://<host>/application/dist/index.html`
- API health: `http://<host>/api/public/index.php/login/checkInternet` (returns `Done`)

Seeding / Initializing the Database

- If the database is empty on first run, import `database.sql`:
  - From host: `docker exec -i mariadb_gam_quiz mysql -uroot -pexam exam < database.sql`

Image Version Pinning (Reproducible Deploys)

- Problem: `latest` can change over time.
- Fix: pin the app image to a specific tag (e.g., commit short SHA):
  - In `docker-compose.yml` set `image: nourddinelearning/savsoftquiz-gam_quiz:bf992de`
- Optional (strongest): pin by digest: `image: nourddinelearning/savsoftquiz-gam_quiz@sha256:<digest>`

Release (Build → Tag → Push → Deploy)

1) Build locally (if you’re changing the app):
   - `docker build -t savsoftquizv60-quiz:latest .`
2) Tag and push to Docker Hub:
   - `TAG=$(git rev-parse --short HEAD)`
   - `docker tag savsoftquizv60-quiz:latest <DOCKERHUB_USERNAME>/savsoftquiz-gam_quiz:$TAG`
   - `docker tag savsoftquizv60-quiz:latest <DOCKERHUB_USERNAME>/savsoftquiz-gam_quiz:latest`
   - `docker push <DOCKERHUB_USERNAME>/savsoftquiz-gam_quiz:$TAG`
   - `docker push <DOCKERHUB_USERNAME>/savsoftquiz-gam_quiz:latest`
3) Update compose to the new tag and deploy:
   - Edit `docker-compose.yml` → `image: <DOCKERHUB_USERNAME>/savsoftquiz-gam_quiz:$TAG`
   - `docker compose pull && docker compose up -d`

CI/CD (GitHub Actions → Docker Hub)

- A workflow is provided at `.github/workflows/docker-publish.yml`.
- Set repo secrets:
  - `DOCKERHUB_USERNAME`: your Docker Hub username or org
  - `DOCKERHUB_TOKEN`: a Docker Hub access token with write permission
- What it does when pushing to `main` or tagging `v*`:
  - Builds the app image from `Dockerfile` and pushes tags: `latest`, `sha-<shortsha>`, and `vYYYY.MM.DD` (plus the git tag if any) to `<DOCKERHUB_USERNAME>/savsoftquiz-gam_quiz`.
  - Pulls `bitnami/mariadb:10.6`, re-tags to `<DOCKERHUB_USERNAME>/mariadb-gam_quiz:10.6` and `latest`, then pushes.
  - Update `docker-compose.yml` to point at these repos/tags for deployments.

Backups (Recommended Daily)

- Logical backup (SQL dump):
  - `docker exec -i mariadb_gam_quiz mysqldump -uroot -pexam --databases exam | gzip > backups/exam-$(date +%F-%H%M%S).sql.gz`
- Physical backup (volume snapshot tar):
  - `docker run --rm -v savsoftquizv60_db-data:/volume -v "$PWD/backups":/backup alpine sh -c 'cd /volume && tar czf /backup/volume-sqldb-$(date +%F-%H%M%S).tgz .'`

Restore

- From SQL dump:
  - `gunzip -c backups/exam-YYYY-mm-dd-HHMMSS.sql.gz | docker exec -i mariadb_gam_quiz mysql -uroot -pexam`
- From volume tar (stops DB briefly):
  - `docker compose stop mariadb`
  - `docker run --rm -v savsoftquizv60_db-data:/volume -v "$PWD/backups":/backup alpine sh -c 'cd /volume && rm -rf ./* && tar xzf /backup/volume-sqldb-YYYY-mm-dd-HHMMSS.tgz'`
  - `docker compose up -d mariadb`

Migrating to a New VM

Option A: Use backups

- Copy `backups/*.sql.gz` or `backups/volume-sqldb-*.tgz` to the new VM and restore (see Restore section).

Option B: Move the named volume

- Export: `docker run --rm -v savsoftquizv60_db-data:/vol -v "$PWD":/bkp alpine sh -c 'cd /vol && tar czf /bkp/db-data.tgz .'`
- Transfer `db-data.tgz` to the new VM
- Create volume and import: `docker volume create savsoftquizv60_db-data` then
  `docker run --rm -v savsoftquizv60_db-data:/vol -v "$PWD":/bkp alpine sh -c 'cd /vol && tar xzf /bkp/db-data.tgz'`

Option C: Bind Mount (portable by default)

- Change compose to use a host path:
  - Replace `- 'db-data:/bitnami/mariadb'` with `- ./data/mariadb:/bitnami/mariadb`
- One-time migrate:
  - `docker run --rm -v savsoftquizv60_db-data:/from -v "$PWD/data/mariadb":/to alpine sh -c 'cd /from && cp -a . /to'`
- Now `./data/mariadb` can be rsynced or snapshotted with the VM disk.

AWS Storage Options

- EBS (recommended for MariaDB): attach, format, mount (e.g., `/mnt/ebs/mariadb`) and bind mount that path in compose.
- EFS: use for shared assets; not ideal for MySQL/MariaDB data due to NFS latency.
- RDS/Aurora: managed DB; point app to RDS, remove local DB persistence.

Troubleshooting

- API 500 “table doesn’t exist”: import `database.sql` (see Seeding).
- Cannot login: ensure the frontend API URL is correct (`application/dist/js/custom.js` generated by `docker-config/custom.js.template` via `DOMAINNAME`).
- Change admin password: `docker exec -i mariadb_gam_quiz mysql -uroot -pexam -e "UPDATE exam.sq_user SET password=MD5('admin') WHERE username='admin';"`
